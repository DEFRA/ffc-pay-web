{% extends '_layout.njk' %}
{% from 'macros/download-statement-fields.njk' import schemeSelect, yearInput, frnInput, submitButton %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
{% from "govuk/components/breadcrumbs/macro.njk" import govukBreadcrumbs %}
{% from "govuk/components/pagination/macro.njk" import govukPagination %}

{% block pageTitle %}
    Download Statements
{% endblock %}

{% block content %}
    {{ govukBreadcrumbs({
        items: [
            { text: "Home", href: "/" },
            { text: "Download Statements" }
        ]
    }) }}

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-full">
            <h1 class="govuk-heading-xl">Download Statements</h1>
        </div>
    </div>

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            {% if error %}
                {{ govukErrorSummary({
                    titleText: "There is a problem",
                    errorList: [{ text: error.message }]
                }) }}
            {% endif %}

            <p class="govuk-body">Search for payment statements. At least one field is required.</p>

            <form method="POST" action="/download-statements">
                <input type="hidden" name="crumb" value="{{ crumb }}"/>

                {{ govukInput({
                    id: "filename",
                    name: "filename",
                    label: {
                        text: "Search using the full filename if known.",
                        classes: "govuk-label--s"
                    },
                    hint: { 
                        html: 'Examples:<br>FFC_PaymentDelinkedStatement_DP_2024_1100021264_2025101508224868.pdf<br>FFC_PaymentSfi23QuarterlyStatement_DP_2024_1100021264_2025101508224868.pdf' 
                    },
                    classes: "govuk-input--width-30",
                    value: filename
                }) }}

                <p class="govuk-body">Or search by individual criteria:</p>

                {{ schemeSelect(schemes, schemeId) }}
                {{ yearInput(marketingYear) }}
                {{ frnInput(frn) }}

                {{ govukInput({
                    id: "timestamp",
                    name: "timestamp",
                    label: {
                        text: "Timestamp",
                        classes: "govuk-label--s"
                    },
                    hint: { text: "16 digits, e.g. 2025101508224868" },
                    classes: "govuk-input--width-20",
                    value: timestamp
                }) }}

                {{ submitButton('Search statements') }}
            </form>

            {% if searchPerformed %}
                <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible"/>

                {% if statements and statements.length > 0 %}
                    {% set resultCount = statements.length %}
                    {% set itemLimit = limit or 50 %}
                    {% set startItem = ((pageNumber - 1) * itemLimit) + 1 %}
                    {% set endItem = startItem + resultCount - 1 %}

                    <h2 class="govuk-heading-m">Results (Page {{ pageNumber }})</h2>
                    <p class="govuk-body-s">
                        Showing items {{ startItem }} to {{ endItem }} on this page ({{ resultCount }} items)
                    </p>

                    <table class="govuk-table">
                        <caption class="govuk-visually-hidden">Search results for payment statements</caption>
                        <thead class="govuk-table__head">
                            <tr class="govuk-table__row">
                                <th scope="col" class="govuk-table__header">Scheme</th>
                                <th scope="col" class="govuk-table__header">Year</th>
                                <th scope="col" class="govuk-table__header">FRN</th>
                                <th scope="col" class="govuk-table__header">Timestamp</th>
                                <th scope="col" class="govuk-table__header">Action</th>
                            </tr>
                        </thead>
                        <tbody class="govuk-table__body">
                            {% for statement in statements %}
                                <tr class="govuk-table__row">
                                    <td class="govuk-table__cell">{{ statement.scheme }}</td>
                                    <td class="govuk-table__cell">{{ statement.year }}</td>
                                    <td class="govuk-table__cell">{{ statement.frn }}</td>
                                    <td class="govuk-table__cell">{{ statement.timestamp }}</td>
                                    <td class="govuk-table__cell">
                                        {% if statement.filename %}
                                            <a href="/download-statements/download/{{ statement.filename }}" class="govuk-link">
                                                Download
                                                <span class="govuk-visually-hidden">
                                                    statement for {{ statement.scheme }}
                                                    {{ statement.year }} FRN {{ statement.frn }}
                                                </span>
                                            </a>
                                        {% else %}
                                            <span class="govuk-body-s">File unavailable</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    {% if continuationToken or pageNumber > 1 %}
                        <form id="pagination-form" method="POST" action="/download-statements" style="display: none;">
                            <input type="hidden" name="crumb" value="{{ crumb }}"/>
                            <input type="hidden" name="schemeId" value="{{ schemeId }}"/>
                            <input type="hidden" name="marketingYear" value="{{ marketingYear }}"/>
                            <input type="hidden" name="frn" value="{{ frn }}"/>
                            <input type="hidden" name="filename" value="{{ filename }}"/>
                            <input type="hidden" name="timestamp" value="{{ timestamp }}"/>
                            <input type="hidden" name="limit" value="{{ itemLimit }}"/>
                            {% if continuationToken %}
                                <input type="hidden" name="continuationToken" id="pagination-continuation-token" value="{{ continuationToken }}"/>
                            {% endif %}
                            <input type="hidden" name="pageNumber" id="pagination-page-number" value="0"/>
                        </form>

                        {% set prevAttrs = {'onclick': "document.getElementById('pagination-page-number').value = " ~ (pageNumber - 2) ~ "; document.getElementById('pagination-form').submit(); return false;"} %}
                        {% set nextAttrs = {'onclick': "document.getElementById('pagination-page-number').value = " ~ pageNumber ~ "; document.getElementById('pagination-form').submit(); return false;"} %}

                        {% if pageNumber > 1 and continuationToken %}
                            {{ govukPagination({ previous: { href: '#', attributes: prevAttrs }, next: { href: '#', attributes: nextAttrs } }) }}
                        {% elif pageNumber > 1 %}
                            {{ govukPagination({ previous: { href: '#', attributes: prevAttrs } }) }}
                        {% else %}
                            {{ govukPagination({ next: { href: '#', attributes: nextAttrs } }) }}
                        {% endif %}
                    {% endif %}
                {% else %}
                    <h2 class="govuk-heading-m">Results</h2>
                    <p class="govuk-body">No statements found.</p>
                {% endif %}
            {% endif %}
        </div>
    </div>
{% endblock %}