{% extends 'report-list/base-report.njk' %}
{% from 'macros/report-form-fields.njk' import reportPageTitle, typeSelect %}
{% from "govuk/components/task-list/macro.njk" import govukTaskList %}

{% set showSubmitButton = govukTaskListData == null %}

{% set reportTitle = 'Status Report' %}
{% set reportSubmitLabel = 'Find Reports' %}
{% set reportUrl = '/report-list/status-report' %}
{% set formAction = '/report-list/status-report/search' %}
{% set reportTypeItems = [
  { value: "sustainable-farming-incentive", text: "SFI" },
  { value: "delinked-payment-statement", text: "Delinked" }
] %}

{% block reportContent %}
  {{ reportPageTitle(reportTitle) }}

  {% if govukTaskListData == null %}
    {{ typeSelect(reportType, reportTypeItems, "Select a scheme") }}
    <div class="govuk-form-group">
      <label class="govuk-label govuk-label-s" for="report-year">Select the year</label>
      <select class="govuk-select" id="report-year" name="report-year">
        {% for year in years %}
          <option value="{{ year.year }}" data-type="{{ year.type }}">{{ year.year }}</option>
        {% else %}
          <option value="" disabled>No reports available</option>
        {% endfor %}
      </select>
    </div>
  {% else %}
    {% if govukTaskListData.items.length %}
      <h2 class="govuk-heading-m">Available reports</h2>
      <div class="task-list-wrapper">
        {{ govukTaskList(govukTaskListData) }}
      </div>
    {% else %}
      <p class="govuk-body">No reports found for the selected year and type.</p>
    {% endif %}
  {% endif %}

<script>
  const typeSelect = document.getElementById('select-type');
  const reportYearSelect = document.getElementById('report-year');
  function filterYears() {
    const selectedType = typeSelect.value;
    for (const option of reportYearSelect.options) {
      if (!option.value) continue;
      option.hidden = option.dataset.type !== selectedType;
    }
    reportYearSelect.value = '';
    const firstVisible = Array.from(reportYearSelect.options).find(opt => !opt.hidden && opt.value);
    if (firstVisible) reportYearSelect.value = firstVisible.value;
  }
  if (typeSelect) {
    typeSelect.addEventListener('change', filterYears);
    filterYears();
  }
</script>
{% endblock %}
